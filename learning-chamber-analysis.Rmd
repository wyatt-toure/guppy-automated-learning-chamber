---
title: "Analysis for the Guppy Learning over WiFi (GLoW) Experiment"
output:
  bookdown::html_document2:
    include:
      highlight: pygments
    css: styles.css
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: false
    number_sections: false
    split_by: section
    
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = 'docs/analysis')
  })
---

<div class="topnav">
  <a href="index.html">Guppy automated learning chamber project site</a>
    <a href="https://github.com/wyatt-toure/guppy-automated-learning-chamber" style = "float: right;">GitHub</a>
    <a class="active" href="analysis.html" style = "float: right;">Analysis</a>
    <a href="python-code-documentation.html" style = "float: right;">Python Code Documentation</a>
    <a href="apparatus-setup.html"style = "float: right;">Apparatus Design</a>
    <a href="manuscript.html" style = "float: right;">Manuscript</a>
    <a href="index.html" style = "float: right;">Home</a>
</div>

<p class="author-name">Beatriz R. Quineche<span class="affil-mark">1*</span>, 
M. Wyatt Toure<span class="affil-mark">1</span>, Simon M. Reader<span class="affil-mark">1</span></p>

<p class="author-affil"><span class="affil-mark">1</span>McGill University, 
Department of Biology, 1205 Docteur Penfield, Montreal, Quebec H3A 1B1, Canada</p>
<p><span class="affil-mark">*</span>Project lead</p>


Date of last update: `r format(Sys.Date(), '%b %d %Y')`

*** 

```{r library-prep, include=FALSE}
library(lme4)
library(tidyr)
library(lmerTest)
library(ggplot2)
library(ggpubr)
library(DHARMa)
library(dplyr)
library(effects)
library(broom)
library(broom.mixed)
library(knitr)
library(emmeans)
library(report)
library(cowplot)
library(tidyext)
source("R/rename-lme4-model.R")
```

```{r data-prep, include=FALSE}
# Reading in data
full_data <- read.csv("data/beatriz-master-data_one.csv")

# Setting batch to a factor
full_data$batch <- as.factor(full_data$batch)

# Creating time at both feeders variable
full_data <- full_data %>%
  mutate(time.both.feeders = (right.feeder.side.time + left.feeder.side.time))

# Removing NAs (1 fish where light didn't go off)
full_data <- full_data %>%
  drop_na()

# Creating rewarding side time variable
full_data <- full_data %>%
  mutate(
    rewarding.side.time =
      case_when(
        light.side == "left" ~ (left.side.time),
        light.side == "right" ~ (right.side.time)
      )
  )

# Creating unrewarding side time variable
full_data <- full_data %>%
  mutate(
    unrewarding.side.time =
      case_when(
        light.side == "left" ~ (right.side.time),
        light.side == "right" ~ (left.side.time)
      )
  )

# Creating rewarding side preference variable
full_data <- full_data %>%
  mutate(rewarding.side.preference = rewarding.side.time - unrewarding.side.time)


# Creating rewarding side latency variable
full_data <- full_data %>%
  mutate(
    rewarding.side.latency =
      case_when(
        light.side == "left" ~ (left.side.latency),
        light.side == "right" ~ (right.side.latency)
      )
  )


# Creating rewarding feeder time variable
full_data <- full_data %>%
  mutate(
    rewarding.feeder.time =
      case_when(
        light.side == "left" ~ (left.feeder.side.time),
        light.side == "right" ~ (right.feeder.side.time)
      )
  )

# Creating unrewarding feeder time variable
full_data <- full_data %>%
  mutate(
    unrewarding.feeder.time =
      case_when(
        light.side == "left" ~ (right.feeder.side.time),
        light.side == "right" ~ (left.feeder.side.time)
      )
  )

# Creating rewarding feeder preference variable
full_data <- full_data %>%
  mutate(rewarding.feeder.preference = rewarding.feeder.time - unrewarding.feeder.time)

# Creating rewarding feeder visits variable
full_data <- full_data %>%
  mutate(
    rewarding.feeder.visits =
      case_when(
        light.side == "left" ~ (left.feeder.side.visits),
        light.side == "right" ~ (right.feeder.side.visits)
      )
  )

# Creating unrewarding feeder visits variable
full_data <- full_data %>%
  mutate(
    unrewarding.feeder.visits =
      case_when(
        light.side == "left" ~ (right.feeder.side.visits),
        light.side == "right" ~ (left.feeder.side.visits)
      )
  )


# Creating rewarding feeder latency variable
full_data <- full_data %>%
  mutate(
    rewarding.feeder.latency =
      case_when(
        light.side == "left" ~ (left.feeder.side.latency),
        light.side == "right" ~ (right.feeder.side.latency)
      )
  )

# Creating unrewarding feeder latency variable
full_data <- full_data %>%
  mutate(
    unrewarding.feeder.latency =
      case_when(
        light.side == "left" ~ (right.feeder.side.latency),
        light.side == "right" ~ (left.feeder.side.latency)
      )
  )

# Creating Change in rewarding feeder latency variable
full_data <- full_data %>%
  mutate(latency.difference = unrewarding.feeder.latency - rewarding.feeder.latency)

# Creating total time variable for data check purposes
full_data <- full_data %>%
  mutate(total.time = left.side.time + right.side.time)

# Setting plot colours
gray <- "#696667"
green <- "#59a14f"
```

## Brief Overview

This is the analysis for an experiment conducted by Beatriz Quineche as part of
an Honour's thesis in the Reader Laboratory at McGill University. The data and R
code to produce this analysis are in the
[beatriz-master-data\_one.csv.csv](https://github.com/wyatt-toure/guppy-automated-learning-chamber/blob/main/data/beatriz-master-data_one.csv)
file and the
[learning-chamber-analysis.Rmd](https://github.com/wyatt-toure/guppy-automated-learning-chamber/blob/main/learning-chamber-analysis.Rmd)
file respectively. A list of variables and their descriptions is given in the
metadata section of the [README]() file. These files can all be accessed at the
[GitHub repository for this project](https://github.com/wyatt-toure/guppy-automated-learning-chamber).

The goal of this project was to conduct of a proof of concept experiment to see
the feasibility of training guppies in a conditioning chamber which consisted of
a tank supplemented with raspberry pi controlled lights and feeders as well as a
raspberry pi camera. Guppies were given a simple classical conditioning task.
Four times a day for three consecutive days a light would briefly illuminate for
five seconds after which the light turned off and food was delivered from a
servo-powered feeder that was hung above the tank 
(see [Apparatus Design](apparatus-setup.html)). 
This resulted in a total of 12 reinforced trials being conducted in the span of 
three days. On the fifth day guppies were food deprived to increase food 
motivation and thus increase the likelihood of eliciting a demonstrable 
behavioural effect for the probe trial which occurred on the sixth day.

The association expected to be formed was that the side of the tank that
produces a light predicts which feeder will have food delivered to it. Guppies
were expected to demonstrate evidence of successfully learning the association
by behaving in the following manner after the light turned on: **1)** increasing
the amount of time spent in the side of the tank where the feeder was located,
**2)** increasing the number of visits (coming within 2 body lengths) to the
rewarded feeder, and/or **3)** approaching the rewarded feeder quicker than the
unrewarded feeder.



*** 

## Data check {.tabset}

### Checking categorical variables

First we want to make sure the data is properly formatted. We will use the
`describe_all_cat` function from the package `tidyext` to do so. This will
summarise all of our categorical variables. Note ID was filtered out for this
table. 

```{r data-checking, echo=FALSE}
# Checking the data
kable(describe_all_cat(full_data) %>%
  filter(Variable != "id"),
caption = "Summary of the frequency of observations for all categorical variables. 
The levels of each variable are given in the group column and the frequency of 
observations within each level are given in the frequency column. The relative 
contribution of a particular level of a variable to the total amount of 
observations within that variable is givin in the % column."
)
```

```{r binom-test, include=FALSE}
# Is the number of individuals tested with left vs right significantly different?
binom.test(12, 34)

# No p = 0.1214
```

Of note is that we have slightly, but not significantly (Exact binomial test p
= 0.121), more individuals for which the light shone on the right side (65%)
versus the left side (35%). All other grouping levels are essentially equal. 

***

### Checking individual observations

Next we will check the data for individuals. All individuals should have two
measures, one for the 'before light' phase and one for the 'after light' phase. 

```{r data-checking2, echo=FALSE}
kable(describe_all_cat(full_data) %>%
  filter(Variable == "id"),
caption = "ID data check table caption"
)
```

***

### Checking total time values

Since we used automated tracking we want to make sure that there are minimal
tracking errors. We measured the time a guppy was on either the left side or
right side of the tank so we can use this to check for any missing data. Since
trials lasted 3 minutes these measures should add up to around 180.

```{r data-checking3, echo=FALSE, message=FALSE}
kable(full_data %>%
  group_by(id, light.status) %>%
  summarise(total.time) %>%
  arrange(total.time),
caption = "Checking tracking data errors"
)
```

***

## Models

We analysed the data using linear mixed effect and generalized linear mixed
effect models with the `lmer()` and `glmer()` functions from `lme4` package.
P-values and effective degrees of freedom were obtained using the `lmerTest`
package. Model residuals were checked they met distributional assumptions with
the `DHARMa` package, you can click the ‘See Model Residuals’ button below the
model formulas to see the residual diagnostic plots produced by `DHARMa` for
that particular model.

### Model 1 - Time on the rewarded side

To determine whether individuals increase their time spent on the side of the
tank the light shone from, we fit a linear mixed effects model with fixed effect
of light status (before or after) as well as a random effect of individual id.
Our response variable, 'rewarding side preference', is the amount of time a
guppy spent on the side which the light shone from subtracted by the time spent
on the other side of the tank. This model asks whether the preference for the
rewarding side of the tank changed between baseline and test and whether this
differs with rewarded object colour.

```{r main-model}
time_model <-
  lmer(rewarding.side.preference ~ light.status + (1 | id),
    data = full_data
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#Model1"> See Model 1 Residuals </button>  
<div id="Model1" class="collapse">  

```{r model-1-residuals, echo=FALSE}
simulationOutput <- simulateResiduals(fittedModel = time_model)
plot(simulationOutput)
```

</div>

```{r tidy-main-model, echo=FALSE}
# Setting table row names
table_row_name_vec <- c("Intercept", "Light status")

# Converting data frame to tibble
tidy_time_model <- broom.mixed::tidy(time_model)

# Changing tibble header names
tidy_time_model <- rename_tidy_lme4_cols(tidy_time_model)

# Changing tibble row names
tidy_time_model[1:2, 3] <- table_row_name_vec
```

</br>

##### Results

```{r knitr-main-model-results, echo=FALSE}
knitr::kable(tidy_time_model[1:2, ] %>%
  dplyr::select(-group, -effect) %>%
  mutate_if(is.numeric, round, digits = 3),
caption = "Summary of a linear mixed effect model (Model 1) estimating the time 
spent on the side of the tank where light had been activated (model estimates 
± S.E.) where the fixed effect is the factor light status (‘before the light’ 
or ‘after the light’) and the random effect of individual id. The effect of 
light status is non-significant, but the estimate indicates guppies approached 
the rewarding feeder quicker than the unrewarding feeder after the light came on."
)
```

There is a non-significant effect of light status (p = `r tidy_time_model$'P value'[2] %>% round(3)`). Guppies
non-significantly increase their preference for the side with the light after
the light has shone by `r tidy_time_model$Estimate[2] %>% round(1)` seconds. 

</br>
```{r rewarding-side-pref-plot, echo=FALSE, fig.align='center', fig.cap="Data are means ± SE. Lines connect individuals across light periods. The dashed line represents the value of the pre-light baseline behavioural measure.", fig.id="rewarding-side-pref-plot", message=FALSE, warning=FALSE}
testing_data_x_axis_labels <- c("Before light", "After light")

time_plot <- ggplot(
  full_data,
  aes(
    x = light.status,
    y = rewarding.side.preference,
    color = light.status
  )
) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = "point", fun = "mean", size = 4.5, shape = c(15, 16)) +
  ylab("Rewarding side preference (sec)") +
  xlab("Light status") +
  labs(col = "Light Status") +
  theme(
    legend.position = "none", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c(gray, green)) +
  geom_line(aes(group = interaction(id)), alpha = 0.2) +
  scale_x_discrete(labels = testing_data_x_axis_labels) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_se",
    position = position_dodge(width = 0),
    width = 0.1
  ) +
  geom_hline(yintercept = -5.92, linetype = "dashed", alpha = 0.4)

time_plot
```

*** 

### Model 2 - Latency to the rewarded side

To determine whether individuals increase the speed at which they come within
two body lengths of the rewarded feeder relative to the unrewarded feeder after
the light turns on we fit a linear mixed effects model. Our response variable
`latency.difference` is the latency to approach the unrewarded feeder subtracted
by the latency to approach the rewarded feeder. Positive values indicate that
the rewarded feeder was approached quicker than the unrewarded feeder. A value
of 0 would indicate both feeders were reached at the same time (in this case
this means both feeders were never approached and thus both values are given a
max score of 180 as it is impossible for guppies to be in two places at once).
The fixed effect is the light status which is either 'before the light turns on'
or 'after the light turns on'. We additionally fit a random effect of individual
id to account for repeated measures.

```{r latency-model}
latency_model <-
  lmer(latency.difference ~ light.status + (1 | id),
    data = full_data
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#Model2"> See Model 2 Residuals </button>  
<div id="Model2" class="collapse">  

```{r model-2-residuals, echo=FALSE}
simulationOutput <- simulateResiduals(fittedModel = latency_model)
plot(simulationOutput)
```

</div>

```{r tidy-latency-model, echo=FALSE}
tidy_latency_model <- broom.mixed::tidy(latency_model)

# Changing tibble header names
tidy_latency_model <- rename_tidy_lme4_cols(tidy_latency_model)

# Changing tibble row names
tidy_latency_model[1:2, 3] <- table_row_name_vec
```

</br>

##### Results

```{r knitr-latency-model-results, echo=FALSE}
knitr::kable(tidy_latency_model[1:2, ] %>%
  dplyr::select(-group, -effect) %>%
  mutate_if(is.numeric, round, digits = 3),
caption = "Summary of a linear mixed effect model (Model 2) estimating how fast 
guppies approached the unrewarded feeder for which the light had been activated 
over the unrewarded feeder with no lights activated (model estimates ± S.E.) 
where the fixed effect is the factor light status (‘before the light’ or ‘after 
the light’). The effect of light status is non-significant, but the estimate 
indicates guppies approached the rewarding feeder quicker than the unrewarding 
feeder after the light came on."
)
```

After the light came on guppies non-significantly approached the rewarded feeder 
on average `r tidy_latency_model$Estimate[2] %>% round(1)` seconds faster than 
the non-rewarded feeder. 

</br>

```{r rewarding-latency-plot, echo=FALSE, fig.cap="Data are means ± SE Bold line connects means across trials.", fig.id="rewarding-latency-plot", warning=FALSE, message=FALSE, fig.align='center'}
testing_data_x_axis_labels <- c("Before light", "After light")

latency_plot <- ggplot(
  full_data,
  aes(
    x = light.status,
    y = latency.difference,
    color = light.status
  )
) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = "point", fun = "mean", size = 4, shape = c(15, 16)) +
  ylab("Rewarded feeder latency bias (sec)") +
  xlab("Light status") +
  labs(col = "Light status") +
  theme(
    legend.position = "none", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c(gray, green)) +
  geom_line(aes(group = id), alpha = 0.2) +
  scale_x_discrete(labels = testing_data_x_axis_labels) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_se",
    position = position_dodge(width = 0),
    width = 0.1
  ) +
  geom_hline(yintercept = -9.94, linetype = "dashed", alpha = 0.5)

latency_plot
```

*** 

### Model 3 - Visits to the rewarded feeder

To determine whether individual increase the frequency with which they come
within two body lengths of the rewarded feder, we fit a binomial generalized
linear mixed effects model. Our response variable, denoted by
`cbind(rewarding.feeder.visits,unrewarding.feeder.visits)` is the proportion of
visits to the rewarded feeder. This model asks whether the proportion of visits
to the rewarded feeder differs between light phases. We fit a random effect of
individual id to account for repeated measures.

```{r visits-model}
visits_model <-
  glmer(cbind(rewarding.feeder.visits, unrewarding.feeder.visits) ~ light.status + (1 | id),
    data = full_data,
    family = "binomial"
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#Model3"> See Model 3 Residuals </button>  
<div id="Model3" class="collapse">  

```{r model-3-residuals, echo=FALSE}
simulationOutput <- simulateResiduals(fittedModel = visits_model)
plot(simulationOutput)
```

</div>

```{r tidy-visits-model, echo=FALSE}
table_row_name_vec <- c("Intercept", "Light status")

tidy_visits_model <- broom.mixed::tidy(visits_model)

# Changing tibble header names
tidy_visits_model <- rename_tidy_lme4_cols(tidy_visits_model)

# Changing tibble row names
tidy_visits_model[1:2, 3] <- table_row_name_vec
```

</br>

##### Results

```{r knitr-visits-model-results, echo=FALSE}
knitr::kable(tidy_visits_model[1:2, ] %>%
  dplyr::select(-group, -effect) %>%
  mutate_if(is.numeric, round, digits = 3),
caption = "Summary of a binomial generalized linear mixed effects model 
(Model 3) estimating the proportion of visits guppies made to the activated 
light side’s feeder (model estimates ± S.E.) where the fixed effect is the 
factor light status (‘before the light’ or ‘after the light’). The effect of 
light status is non-significant, but the estimate indicates guppies increase 
their visits to the unrewarding feeder after its corresponding light had been 
activated."
)
```

There is a non-significant increase in the proportion of visits to the rewarded
feeder after the light turns on. Guppies go from making 47% of their visits to
the rewarded feeder before the light shines to making 57% of their visits being
to the rewarded feeder after the light shines, an increase of 10%.

</br>


```{r rewarding-visits-plot, echo=FALSE, fig.cap="Data are means ± SE Bold line connects means across trials.", fig.id="rewarding-visits-plot", warning=FALSE, message=FALSE, fig.align='center'}
testing_data_x_axis_labels <- c("Before light", "After light")

visits_plot <- ggplot(
  full_data,
  aes(
    x = light.status,
    y = (rewarding.feeder.visits / (rewarding.feeder.visits + unrewarding.feeder.visits)),
    color = light.status
  )
) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = "point", fun = "mean", size = 4, shape = c(15, 16)) +
  ylab("Proportion of visits to rewarded feeder") +
  xlab("Light status") +
  labs(col = "Light status") +
  theme(
    legend.position = "none", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c(gray, green)) +
  geom_line(aes(group = id), alpha = 0.2) +
  scale_x_discrete(labels = testing_data_x_axis_labels) +
  stat_summary(geom = "errorbar", fun.data = "mean_se", position = position_dodge(width = 0), width = 0.1) +
  geom_hline(yintercept = 0.461, linetype = "dashed", alpha = 0.5)

visits_plot
```

*** 

## Main findings

1)  Guppies non-significantly increase the amount of time they spend on the side
    of the tank where the light shone (Figure 4A)
2)  Guppies non-significantly increase the speed at which they visit the
    rewarded feeder over the unrewarded feeder after the light shines
    (Figure 4B)
3)  Guppies non-significantly increase their proportion of visits to the
    rewarded feeder after the light shines (Figure 4C)

```{r full-3-panel-plot, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Data are means ± SE. Dashed lines represent mean values for the pre-light baseline of the behaviour being displayed. Squares represent pre-light baselines and circles represent post-light measures. (A) Plot for rewarding side preference in seconds (B) Plot for rewarding feeder latency bias (C) Plot for proportion of visits to the rewarding feeder", fig.id="full-3-panel-plot"}
library(patchwork)
time_plot <- time_plot + theme(
  legend.position = "none",
  axis.title = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA, size = 1),
  axis.line.x = element_blank(), axis.line.y = element_blank(),
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank()
) + ggtitle("Time (sec)")

latency_plot <- latency_plot + theme(
  legend.position = "none",
  axis.title = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA, size = 1),
  axis.line.x = element_blank(), axis.line.y = element_blank(),
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank()
) + ggtitle("Latency (sec)")

visits_plot <- visits_plot + theme(
  legend.position = "none",
  axis.title = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA, size = 1),
  axis.line.x = element_blank(), axis.line.y = element_blank(),
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank()
) + ggtitle("Visits")

(time_plot | latency_plot | visits_plot) + plot_annotation(tag_levels = "A") &
  theme(
    plot.tag.position = c(0, 1),
    plot.tag = element_text(hjust = -3.65, vjust = 3.7)
  )

# Saving plot to images directory for manuscript
ggsave(
  filename = "main-result-plot.png",
  path = "images/",
  device = "png",
  dpi = 300
)
```


We see that while the effect of the light turning is not significant for any one
preference measure, they all have an effect size that is in the direction
consistent with the hypothesis that guppies can learn a food-light association
in the automated chamber.

Our sample of guppies has a high amount of variation leading to estimates with
wide confidence intervals. Moreover, our sample is relatively small so the
decrease in estimate precision due to sampling error is amplified. There could
be several reasons for this variation. Given that we did not explicitly quantify
performance during training it may be that guppies that did not perform any of
the behaviours suggesting learning of the association did not feed as much as
guppies which did, leading to a difference in performance on the test trial. If
we assume guppies did receive similar reinforcement, there may still be
variation due to individual differences in the expression of learned behaviour.

Individual guppies may express learning in different manners. Some may choose to
spend more time on the side with the feeder while others may choose to make more
visits to the feeder. In this case, the strongest and most common responses are
more likely to produce statistically significant estimates as they will have
less variance. Latency we might expect to be a particularly noisy measure
because it depends on where an individual was in the tank when the light came
on. By chance, individuals may have been further away or closer to the feeder
when the light came on which could produce additional variation on the latency
metric. The low precision on the estimate of the effect of light status on time
spent on the rewarding side of the tank may be due to side biases. While
non-significant, guppies that had the light shine on the right side of the tank
increased their preference for the right side of the tank more than the guppies
that had the light shine on the left side of the tank increased their preference
for the left side of the tank. Problematically this could be an artefact of
sample size—there were nearly double the guppies for which the light shone on
the right side of the tank versus the left (11 on the right vs 6 on the left).


*** 

## Follow up data exploration

Following the results for our *a priori* hypotheses we conducted some post-hoc
explorations into the data which are detailed in the sections below.

### Side bias

From Simon: *"I'd suggest also calculating time on left - right, and plotting
against side illuminated - this will help to illustrate any side bias"*.

There is not a statistically clear side bias either way. For the 'light on the
left' guppies there appears to be a slight bias but this may be an artefact of
sample size (the confidence interval around the mean is very wide), there are 6
guppies for which the light shone on the left while there are almost double the
guppies for which the light shone on the right (11 guppies). Investigating this
in a model reveals no significant effects.

```{r side-bias-plot, echo=FALSE, message=FALSE}
facet.labels <- c("Light on left", "Light on right")
names(facet.labels) <- c("left", "right")

ggplot(
  full_data,
  aes(
    x = light.status,
    y = right.side.time - left.side.time,
    shape = light.side,
    colour = light.status
  )
) +
  theme_cowplot() +
  scale_shape_manual(values = c(15, 16)) +
  scale_color_manual(values = c(gray, green)) +
  geom_point() +
  facet_wrap(~light.side, labeller = labeller(light.side = facet.labels)) +
  stat_summary(geom = "point", fun = "mean", size = 4) +
  stat_summary(geom = "errorbar", 
               fun.data = "mean_se", 
               position = position_dodge(width = 0), 
               width = 0.1) +
  geom_line(aes(group = id), color = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.3) +
  ylab("Right side bias") +
  xlab("Light status") +
  theme(
    legend.position = "none", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_x_discrete(labels = testing_data_x_axis_labels)

# Saving plot to images directory for manuscript
ggsave(
  filename = "side-bias-plot.png",
  path = "images/",
  device = "png",
  dpi = 300
)
```

### Time bins

From Simon: *"One possibility is that an initial preference is wiped out once
fish discover no food. So you could look at 1st minute or whatever time period
seems sensible"*

Behaviour might be structured temporally so we wanted to see whether there were
differences in behaviour that were apparent by binning the data into 1 minute
bins.

```{r time-bin-data-prep, echo=FALSE}
# Reading in data
time.bin.data <- read.csv("data/learning-chamber-time-bins-data.csv")

# Setting minute to factor
time.bin.data$minute <- as.factor(time.bin.data$minute)

# Creating time at both feeders variable
time.bin.data <- time.bin.data %>%
  mutate(time.both.feeders = (right.feeder.side.time + left.feeder.side.time))

# Removing NAs (1 fish where light didn't go off)
time.bin.data <- time.bin.data %>%
  drop_na()

# Creating rewarding side time variable
time.bin.data <- time.bin.data %>%
  mutate(
    rewarding.side.time =
      case_when(
        light.side == "left" ~ (left.side.time),
        light.side == "right" ~ (right.side.time)
      )
  )

# Creating unrewarding side time variable
time.bin.data <- time.bin.data %>%
  mutate(
    unrewarding.side.time =
      case_when(
        light.side == "left" ~ (right.side.time),
        light.side == "right" ~ (left.side.time)
      )
  )

# Creating rewarding side preference variable
time.bin.data <- time.bin.data %>%
  mutate(rewarding.side.preference = rewarding.side.time - unrewarding.side.time)


# Creating rewarding side latency variable
time.bin.data <- time.bin.data %>%
  mutate(
    rewarding.side.latency =
      case_when(
        light.side == "left" ~ (left.side.latency),
        light.side == "right" ~ (right.side.latency)
      )
  )


# Creating rewarding feeder time variable
time.bin.data <- time.bin.data %>%
  mutate(
    rewarding.feeder.time =
      case_when(
        light.side == "left" ~ (left.feeder.side.time),
        light.side == "right" ~ (right.feeder.side.time)
      )
  )

# Creating unrewarding feeder time variable
time.bin.data <- time.bin.data %>%
  mutate(
    unrewarding.feeder.time =
      case_when(
        light.side == "left" ~ (right.feeder.side.time),
        light.side == "right" ~ (left.feeder.side.time)
      )
  )

# Creating rewarding feeder preference variable
time.bin.data <- time.bin.data %>%
  mutate(rewarding.feeder.preference = rewarding.feeder.time - unrewarding.feeder.time)

# Creating rewarding feeder visits variable
time.bin.data <- time.bin.data %>%
  mutate(
    rewarding.feeder.visits =
      case_when(
        light.side == "left" ~ (left.feeder.side.visits),
        light.side == "right" ~ (right.feeder.side.visits)
      )
  )

# Creating unrewarding feeder visits variable
time.bin.data <- time.bin.data %>%
  mutate(
    unrewarding.feeder.visits =
      case_when(
        light.side == "left" ~ (right.feeder.side.visits),
        light.side == "right" ~ (left.feeder.side.visits)
      )
  )


# Creating rewarding feeder latency variable
time.bin.data <- time.bin.data %>%
  mutate(
    rewarding.feeder.latency =
      case_when(
        light.side == "left" ~ (left.feeder.side.latency),
        light.side == "right" ~ (right.feeder.side.latency)
      )
  )

# Creating unrewarding feeder latency variable
time.bin.data <- time.bin.data %>%
  mutate(
    unrewarding.feeder.latency =
      case_when(
        light.side == "left" ~ (right.feeder.side.latency),
        light.side == "right" ~ (left.feeder.side.latency)
      )
  )

# Creating Change in rewarding feeder latency variable
time.bin.data <- time.bin.data %>%
  mutate(latency.difference = unrewarding.feeder.latency - rewarding.feeder.latency)

# Creating total time variable for data check purposes
time.bin.data <- time.bin.data %>%
  mutate(total.time = left.side.time + right.side.time)
```


```{r time-on-side-bin-plot, echo=FALSE}
time.bin.plot <- ggplot(
  time.bin.data,
  aes(
    x = minute,
    y = rewarding.side.preference,
    color = light.status
  )
) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = "point", fun = "mean", size = 4.5) +
  ylab("Rewarding side preference (sec)") +
  labs(col = "Light Status") +
  theme(
    legend.position = "top", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c(gray, green)) +
  geom_line(aes(group = interaction(id, light.status)), alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_se",
    position = position_dodge(width = 0),
    width = 0.1
  )

time.bin.plot
```

```{r time-in-feeder-bin-plot, echo=FALSE}
feeder.bin.plot <- ggplot(
  time.bin.data,
  aes(
    x = minute,
    y = rewarding.feeder.preference,
    color = light.status
  )
) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = "point", fun = "mean", size = 4.5) +
  ylab("Rewarding feeder preference (sec)") +
  labs(col = "Light Status") +
  theme(
    legend.position = "top", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c(gray, green)) +
  geom_line(aes(group = interaction(id, light.status)), alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_se",
    position = position_dodge(width = 0),
    width = 0.1
  )

feeder.bin.plot
```

```{r latency-difference-bin-plot, echo=FALSE}
feeder.latency.bin.plot <- ggplot(
  time.bin.data,
  aes(
    x = minute,
    y = latency.difference,
    color = light.status
  )
) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = "point", fun = "mean", size = 4.5) +
  ylab("Rewarding feeder latency bias (sec)") +
  labs(col = "Light Status") +
  theme(
    legend.position = "top", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c(gray, green)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_line(aes(group = interaction(id, light.status)), alpha = 0.2) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_se",
    position = position_dodge(width = 0),
    width = 0.1
  )

feeder.latency.bin.plot
```

```{r feeder-visits-bin-plot, echo=FALSE, warning=FALSE}
feeder.visits.bin.plot <- ggplot(
  time.bin.data,
  aes(
    x = minute,
    y = (rewarding.feeder.visits / (rewarding.feeder.visits + unrewarding.feeder.visits)),
    color = light.status
  )
) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = "point", fun = "mean", size = 4.5) +
  ylab("Rewarding feeder visits") +
  labs(col = "Light Status") +
  theme(
    legend.position = "top", axis.text.x = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c(gray, green)) +
  geom_line(aes(group = interaction(id, light.status)), alpha = 0.2) +
  geom_hline(yintercept = 0.5, linetype = "dashed", alpha = 0.5) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_se",
    position = position_dodge(width = 0),
    width = 0.1
  )

feeder.visits.bin.plot
```

***

## Tools used and References

A complete list of the tools used is produced below:

```{r, echo=FALSE, warning=FALSE}
knitr::kable(as.data.frame(report(sessionInfo())))
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>