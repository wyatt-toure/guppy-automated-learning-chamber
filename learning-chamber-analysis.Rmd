---
title: "Analysis for the Guppy Learning over WiFi (GLoW) Experiment"
output:
  bookdown::html_document2:
    include:
      highlight: pygments
    css: styles.css
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: false
    number_sections: false
    split_by: section
    
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = 'docs/analysis')
  })
---

<div class="topnav">
  <a href="index.html">Home</a>
   <a href="apparatus-setup.html">Apparatus Design</a>
   <a href="python-code-documentation.html">Python Code Documentation</a>
  <a href="procedure.html">Procedure</a>
    <a class="active" href="analysis.html">Analysis</a>
</div>

<p class="author-name">Beatriz R. Quineche<span class="affil-mark">1*</span>, M. Wyatt Toure<span class="affil-mark">1</span>, Simon M. Reader<span class="affil-mark">1</span></p>

<p class="author-affil"><span class="affil-mark">1</span>McGill University, Department of Biology, 1205 Docteur Penfield, Montreal, Quebec H3A 1B1, Canada</p>
<p><span class="affil-mark">*</span>Corresponding Author: <br>Beatriz R. Quineche<br> e-mail: <br></p>

Date of last update: `r format(Sys.Date(), '%b %d %Y')`


```{r library-prep, include=FALSE}
library(lme4)
library(tidyr)
library(lmerTest)
library(ggplot2)
library(ggpubr)
library(DHARMa)
library(dplyr)
library(effects)
library(broom)
library(broom.mixed)
library(knitr)
library(emmeans)
library(report)
library(cowplot)
library(tidyext)
```

```{r data-prep, include=FALSE}
# Reading in data
full.data = read.csv('data/beatriz-master-data_one.csv')

# Setting batch to a factor 
full.data$batch = as.factor(full.data$batch)

# Creating time at both feeders variable 
full.data = full.data %>% mutate(time.both.feeders = (right.feeder.side.time+left.feeder.side.time))

# Removing NAs (1 fish where light didn't go off)

full.data = full.data %>%  drop_na()

# Creating rewarding side time variable

full.data = full.data %>% mutate(rewarding.side.time = (case_when(
  light.side == "left" ~ (left.side.time),
  light.side == "right" ~ (right.side.time)
)))

# Creating unrewarding side time variable

full.data = full.data %>% mutate(unrewarding.side.time = (case_when(
  light.side == "left" ~ (right.side.time),
  light.side == "right" ~ (left.side.time)
)))

# Creating rewarding side preference variable

full.data = full.data %>% mutate(rewarding.side.preference = rewarding.side.time - unrewarding.side.time)


# Creating rewarding side latency variable

full.data = full.data %>% mutate(rewarding.side.latency = (case_when(
  light.side == "left" ~ (left.side.latency),
  light.side == "right" ~ (right.side.latency)
)))


# Creating rewarding feeder time variable 

full.data = full.data %>% mutate(rewarding.feeder.time = (case_when(
  light.side == "left" ~ (left.feeder.side.time),
  light.side == "right" ~ (right.feeder.side.time)
)))

# Creating unrewarding feeder time variable 

full.data = full.data %>% mutate(unrewarding.feeder.time = (case_when(
  light.side == "left" ~ (right.feeder.side.time),
  light.side == "right" ~ (left.feeder.side.time)
)))

# Creating rewarding feeder preference variable 

full.data = full.data %>% mutate(rewarding.feeder.preference = rewarding.feeder.time-unrewarding.feeder.time)

# Creating rewarding feeder visits variable 

full.data = full.data %>% mutate(rewarding.feeder.visits = (case_when(
  light.side == "left" ~ (left.feeder.side.visits),
  light.side == "right" ~ (right.feeder.side.visits)
)))

# Creating unrewarding feeder visits variable 

full.data = full.data %>% mutate(unrewarding.feeder.visits = (case_when(
  light.side == "left" ~ (right.feeder.side.visits),
  light.side == "right" ~ (left.feeder.side.visits)
)))


# Creating rewarding feeder latency variable 

full.data = full.data %>% mutate(rewarding.feeder.latency = (case_when(
  light.side == "left" ~ (left.feeder.side.latency),
  light.side == "right" ~ (right.feeder.side.latency)
)))

# Creating unrewarding feeder latency variable 

full.data = full.data %>% mutate(unrewarding.feeder.latency = (case_when(
  light.side == "left" ~ (right.feeder.side.latency),
  light.side == "right" ~ (left.feeder.side.latency)
)))

# Creating Change in rewarding feeder latency variable 

full.data = full.data %>% mutate(latency.difference = unrewarding.feeder.latency-rewarding.feeder.latency)

# Creating total time variable for data check purposes

full.data = full.data %>% mutate(total.time = left.side.time+right.side.time)

# Setting plot colours 
gray = '#696667'
green = '#59a14f'
```

*** 

## Brief Overview

This is the analysis for an experiment conducted by Beatriz Quineche as part of an Honour's thesis in the Reader Laboratory at McGill University. The data and R code to produce this analysis are in the [learning-chamber-data.csv]() file and the [learning-chamber-analysis-script.Rmd]() file respectively. A list of variables and their descriptions is given in the metadata section of the [README]() file. These files can all be accessed at the [GitHub repository for this project](). 

The goal of this project was to conduct of a proof of concept experiment to see the feasibility of training guppies in a conditioning chamber which consisted of a tank supplemented with raspberry pi controlled lights and feeders as well as a raspberry pi camera. Guppies were given a simple classical conditioning task. Four times a day for X consecutive days a light would briefly illuminate at an LED value of [LED value of the green light] for Y seconds. Z seconds later, food was delivered from a servo-powered feeder that was hung above the tank (see [Apparatus Design](apparatus-setup.html)). This resulted in a total of 16 reinforced trials being conducted in the span of X days. On the fifth day guppies were food deprived to increase food motivation and thus increase the likelihood of eliciting a demonstrable behavioural effect for the probe trial which occurred on the sixth day. 

The association expected to be formed was that the side of the tank that produces a light predicts which feeder will have food delivered to it. Guppies were expected to demonstrate evidence of successfully learning the association by behaving in the following manner after the light turned on: **1)** increasing the amount of time spent in the side of the tank where the feeder was located, **2)** increasing the number of visits (coming within 2 body lengths) to the rewarded feeder, and/or **3)** approaching the rewarded feeder quicker than the unrewarded feeder.



*** 

## Data check {.tabset}

### Checking categorical variables

First we want to make sure the data is properly formatted. We will use the `describe_all_cat` function from the package `tidyext` to do so. This will summarise all of our categorical variables. Note ID was filtered out for this table. 

```{r data-checking, echo=FALSE}
# Checking the data 
kable(describe_all_cat(full.data) %>% filter(Variable != 'id'), caption = "Summary of the frequency of observations for all categorical variables. The levels of each variable are given in the group column and the frequency of observations within each level are given in the frequency column. The relative contribution of a particular level of a variable to the total amount of observations within that variable is givin in the % column.")
```

```{r binom-test, include=FALSE}
# Is the number of individuals tested with left vs right significantly different?
binom.test(12, 34)

# No p = 0.1214
```

Of note is that we have slightly, but not significantly (Exact binomial test p = 0.121), more individuals for which the light shone on the right side (65%) versus the left side (35%). All other grouping levels are essentially equal. 

### Checking individual observations

Next we will check the data for individuals. All individuals should have two measures, one for the 'before light' phase and one for the 'after light' phase. 

```{r data-checking2, echo=FALSE}
kable(describe_all_cat(full.data) %>% filter(Variable == 'id'), caption = "ID data check table caption")
```

### Checking total time values

Since we used automated tracking we want to make sure that there are minimal tracking errors. We measured the time a guppy was on either the left side or right side of the tank so we can use this to check for any missing data. Since trials lasted 3 minutes these measures should add up to around 180. 

```{r data-checking3, echo=FALSE, message=FALSE}
kable(full.data %>% group_by(id, light.status) %>% summarise(total.time) %>% arrange(total.time), caption = "Checking tracking data errors")
```

***

## Models

### Model 1 - Time on the rewarded side

To determine whether individuals increase their time spent on the side of the tank the light shone from, we fit a linear mixed effects model with fixed effect of light status (before or after) as well as a random effect of individual id. Our response variable, 'rewarding side preference', is the amount of time a guppy spent on the side which the light shone from subtracted by the time spent on the other side of the tank. This model asks whether the preference for the rewarding side of the tank changed between baseline and test and whether this differs with rewarded object colour. 

```{r main-model}
time.model = 
  lmer(rewarding.side.preference ~ light.status + (1 | id), 
     data = full.data) 
```

```{r tidy-main-model, echo=FALSE}
# Setting table row names
table.row.name.vec = c("Intercept", "Light status")
                       
# Converting data frame to tibble
tidy_time.model = broom.mixed::tidy(time.model)

# Changing tibble header names 
tidy_time.model = rename(tidy_time.model, "Factor" = term, "Estimate" = estimate, "Std. Error" = std.error, "T statistic" = statistic, "P value" = p.value)

# Changing tibble row names 
tidy_time.model[1:2,3] <- table.row.name.vec
```

</br>

##### Results

```{r knitr-main-model-results, echo=FALSE}
knitr::kable(tidy_time.model[1:2,] %>% dplyr::select(-group, -effect)%>% mutate_if(is.numeric, round, digits = 3), caption = "Time model table caption")
```

There is a non-significant effect of light status (p = 0.276). Guppies non-significantly increase their preference for the side with the light after the light has shone by 26.6 seconds. 

</br>
```{r rewarding-side-pref-plot, echo=FALSE, fig.align='center', fig.cap="Data are means ± SE. Lines connect individuals across light periods. The dashed line represents the value of the pre-light baseline behavioural measure.", fig.id="rewarding-side-pref-plot", message=FALSE, warning=FALSE}
testing.data.x.axis.labels = c("Before light", "After light")

time.plot = ggplot(full.data,
            aes(x = light.status,
                y = rewarding.side.preference,
                color = light.status)) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = 'point', fun = 'mean', size = 4.5, shape = c(15,16)) +
  ylab('Rewarding side preference (sec)') +
  xlab("Light status") +
  labs(col = "Light Status") +
  theme(legend.position = "none", axis.text.x = element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        plot.title = element_text(size=16, hjust=0.5)) +
  scale_color_manual(values=c(gray, green)) +
  geom_line(aes(group = interaction(id)), alpha = 0.2) +
  scale_x_discrete(labels = testing.data.x.axis.labels) +
  stat_summary(geom = 'errorbar', fun.data = 'mean_se', position = position_dodge(width=0), width = 0.1) + 
  geom_hline(yintercept = -5.92, linetype = 'dashed', alpha = 0.4)

time.plot
```

*** 

### Model 2 - Latency to the rewarded side

To determine whether individuals increase the speed at which they come within two body lengths of the rewarded feeder relative to the unrewarded feeder after the light turns on we fit a linear mixed effects model. Our response variable `latency.difference` is the latency to approach the unrewarded feeder subtracted by the latency to approach the rewarded feeder. Positive values indicate that the rewarded feeder was approached quicker than the unrewarded feeder. A value of 0 would indicate both feeders were reached at the same time (in this case this means both feeders were never approached and thus both values are given a max score of 180 as it is impossible for guppies to be in two places at once). The fixed effect is the light status which is either 'before the light turns on' or 'after the light turns on'. We additionally fit a random effect of individual id to account for repeated measures. 

```{r latency-model}
latency.model = 
  lmer(latency.difference ~ light.status + (1 | id), 
                       data = full.data)
```

```{r tidy-latency-model, echo=FALSE}
tidy_latency.model = broom.mixed::tidy(latency.model)

# Changing tibble header names 
tidy_latency.model = rename(tidy_latency.model, "Factor" = term, "Estimate" = estimate, "Std. Error" = std.error, "T statistic" = statistic, "P value" = p.value)

# Changing tibble row names 
tidy_latency.model[1:2,3] <- table.row.name.vec
```

</br>

##### Results

```{r knitr-latency-model-results, echo=FALSE}
knitr::kable(tidy_latency.model[1:2,] %>% dplyr::select(-group, -effect)%>% mutate_if(is.numeric, round, digits = 3), caption = "Latency model table caption")
```

Results go here

</br>

```{r rewarding-latency-plot, echo=FALSE, fig.cap="Data are means ± SE Bold line connects means across trials.", fig.id="rewarding-latency-plot", warning=FALSE, message=FALSE, fig.align='center'}
testing.data.x.axis.labels = c("Before light", "After light")

latency.plot = ggplot(full.data,
            aes(x = light.status,
                y = latency.difference,
                color = light.status)) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = 'point', fun = 'mean', size = 4, shape = c(15,16)) +
  ylab('Rewarded feeder latency bias (sec)') +
  xlab("Light status") +
  labs(col = "Light status") +
  theme(legend.position = "none", axis.text.x = element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        plot.title = element_text(size=16, hjust=0.5)) +
  scale_color_manual(values=c(gray, green)) +
  geom_line(aes(group = id), alpha = 0.2) +
  scale_x_discrete(labels = testing.data.x.axis.labels) +
  stat_summary(geom = 'errorbar', fun.data = 'mean_se', position = position_dodge(width=0), width = 0.1) + 
  geom_hline(yintercept = -9.94, linetype = 'dashed', alpha = 0.5)

latency.plot
```

*** 

### Model 3 - Visits to the rewarded feeder

To determine whether individual increase the frequency with which they come within two body lengths of the rewarded feder, we fit a binomial generalized linear mixed effects model. Our response variable, denoted by `cbind(rewarding.feeder.visits,unrewarding.feeder.visits)` is the proportion of visits to the rewarded feeder. This model asks whether the proportion of visits to the rewarded feeder differs between light phases. We fit a random effect of individual id to account for repeated measures. 

```{r visits-model}
visits.model = 
  glmer(cbind(rewarding.feeder.visits,unrewarding.feeder.visits) ~ light.status  + (1 | id), 
        data = full.data, family = 'binomial')
```

```{r tidy-visits-model, echo=FALSE}
table.row.name.vec = c("Intercept", "Light status")

tidy_visits.model = broom.mixed::tidy(visits.model)

# Changing tibble header names 
tidy_visits.model = rename(tidy_visits.model, "Factor" = term, "Estimate" = estimate, "Std. Error" = std.error, "T statistic" = statistic, "P value" = p.value)

# Changing tibble row names 
tidy_visits.model[1:2,3] <- table.row.name.vec
```

</br>

##### Results

```{r knitr-visits-model-results, echo=FALSE}
knitr::kable(tidy_visits.model[1:2,] %>% dplyr::select(-group, -effect)%>% mutate_if(is.numeric, round, digits = 3), caption = "Visits model table caption")
```

There is a non-significant increase in the proportion of visits to the rewarded feeder after the light turns on. Guppies go from making 47% of their visits to the rewarded feeder before the light shines to making 57% of their visits being to the rewarded feeder after the light shines, an increase of 10%. 

</br>


```{r rewarding-visits-plot, echo=FALSE, fig.cap="Data are means ± SE Bold line connects means across trials.", fig.id="rewarding-visits-plot", warning=FALSE, message=FALSE, fig.align='center'}
testing.data.x.axis.labels = c("Before light", "After light")

visits.plot = ggplot(full.data,
            aes(x = light.status,
                y = (rewarding.feeder.visits/(rewarding.feeder.visits+unrewarding.feeder.visits)),
                color = light.status)) +
  theme_cowplot() +
  geom_point(alpha = 0.3, color = "grey") +
  stat_summary(geom = 'point', fun = 'mean', size = 4, shape = c(15,16)) +
  ylab('Proportion of visits to rewarded feeder') +
  xlab("Light status") +
  labs(col = "Light status") +
  theme(legend.position = "none", axis.text.x = element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        plot.title = element_text(size=16, hjust=0.5)) +
  scale_color_manual(values=c(gray, green)) +
  geom_line(aes(group = id), alpha = 0.2) +
  scale_x_discrete(labels = testing.data.x.axis.labels) + 
  stat_summary(geom = 'errorbar', fun.data = 'mean_se', position = position_dodge(width=0), width = 0.1) +
  geom_hline(yintercept = 0.461, linetype = 'dashed', alpha = 0.5)

visits.plot
```

*** 

## Main findings

1) Guppies non-significantly increase the amount of time they spend on the side of the tank where the light shone (Figure 4A)
2) Guppies non-significantly increase the speed at which they visit the rewarded feeder over the unrewarded feeder after the light shines (Figure 4B)
3) Guppies non-significantly increase their proportion of visits to the rewarded feeder after the light shines (Figure 4C)

```{r full-3-panel-plot, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Data are means ± SE. Dashed lines represent mean values for the pre-light baseline of the behaviour being displayed. Squares represent pre-light baselines and circles represent post-light measures. (A) Plot for rewarding side preference in seconds (B) Plot for rewarding feeder latency bias (C) Plot for proportion of visits to the rewarding feeder", fig.id="full-3-panel-plot"}
library(patchwork)
time.plot = time.plot + theme(legend.position = "none",
        axis.title = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line.x = element_blank(), axis.line.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) + ggtitle("Time")

latency.plot = latency.plot + theme(legend.position = "none",
        axis.title = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line.x = element_blank(), axis.line.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) + ggtitle("Latency")

visits.plot = visits.plot + theme(legend.position = "none",
        axis.title = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line.x = element_blank(), axis.line.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) + ggtitle("Visits")

(time.plot | latency.plot | visits.plot) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0, 1),
        plot.tag = element_text(hjust = -3.65, vjust = 3.7))
```

We see that while the effect of the light turning is not significant for any one preference measure, they all have an effect size that is in the direction consistent with the hypothesis that guppies can learn a food-light association in the automated chamber.  

Our sample of guppies has a high amount of variation leading to estimates with wide confidence intervals. Moreover, our sample is relatively small so the decrease in estimate precision due to sampling error is amplified. There could be several reasons for this variation. Given that we did not explicitly quantify performance during training it may be that guppies that did not perform any of the behaviours suggesting learning of the association did not feed as much as guppies which did, leading to a difference in performance on the test trial. If we assume guppies did receive similar reinforcement, there may still be variation due to individual differences in the expression of learned behaviour. 

Individual guppies may express learning in different manners. Some may choose to spend more time on the side with the feeder while others may choose to make more visits to the feeder. In this case, the strongest and most common responses are more likely to produce statistically significant estimates as they will have less variance. Latency we might expect to be a particularly noisy measure because it depends on where an individual was in the tank when the light came on. By chance, individuals may have been further away or closer to the feeder when the light came on which could produce additional variation on the latency metric. The low precision on the estimate of the effect of light status on time spent on the rewarding side of the tank may be due to side biases. While non-significant, guppies that had the light shine on the right side of the tank increased their preference for the right side of the tank more than the guppies that had the light shine on the left side of the tank increased their preference for the left side of the tank. Problematically this could be an artefact of sample size—there were nearly double the guppies for which the light shone on the right side of the tank versus the left (11 on the right vs 6 on the left). 


*** 

## Follow up data exploration

### Side bias 

From Simon: *"I'd suggest also calculating time on left - right, and plotting against side illuminated - this will help to illustrate any side bias"*.

There does not appear to be a consistent side bias either way. For the 'light on the left' guppies there appears to be a slight bias but this may be an artefact of sample size, there are 6 guppies for which the light shone on the left while there are almost double the guppies for which the light shone on the right (11 guppies). Investigating this in a model reveals no significant effects. 

```{r side-bias-plot, echo=FALSE}
facet.labels = c("Light on left", "Light on right")
names(facet.labels) <- c("left", "right")

ggplot(full.data, 
       aes(x = light.status, 
           y = right.side.time-left.side.time, 
           shape = light.side, 
           colour = light.status)) + 
  theme_cowplot() +
  scale_shape_manual(values = c(15,16)) +
  scale_color_manual(values=c(gray, green)) +
  geom_point() + 
  facet_wrap(~light.side, labeller = labeller(light.side = facet.labels)) +
    stat_summary(geom = 'point', fun = 'mean', size = 4) + 
  stat_summary(geom = 'errorbar', fun.data = 'mean_se', position = position_dodge(width=0), width = 0.1) +
  geom_line(aes(group = id), color = 'grey', alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = 'dashed', alpha = 0.3) +
  ylab('Right side bias') +
  xlab("Light status") +
  theme(legend.position = "none", axis.text.x = element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        plot.title = element_text(size=16, hjust=0.5)) +
  scale_x_discrete(labels = testing.data.x.axis.labels)
```

***

</br>

## Tools used and References

A complete list of the tools used is produced below:

```{r, echo=FALSE, warning=FALSE}
knitr::kable(as.data.frame(report(sessionInfo())))
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>